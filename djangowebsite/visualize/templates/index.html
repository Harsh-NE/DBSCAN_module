{% extends 'base.html' %}
{% load static %}

{% block body %}
<h2 class="title">Visualize it Yourself!!!</h2>
<div style="display: flex; justify-content:space-around ">
<div class="canvas-controls-container">
  <canvas id="canvas" width="400" height="400"></canvas>
  <div class="param-inputs">
    <input type="number" id="epsilon" placeholder="Epsilon (e.g., 50)" />
    <input type="number" id="minPts" placeholder="MinPts (e.g., 3)" />
    <button onclick="startAnimation()">Visualize DBSCAN</button>
  </div>
</div>

<img id="frameImg" width="400" height="400">
</div>
<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let points = [];

  canvas.addEventListener("click", (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = Math.round(e.clientX - rect.left);
    const y = Math.round(e.clientY - rect.top);
    points.push({x, y});
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, 2 * Math.PI);
    ctx.fillStyle = "black";
    ctx.fill();
  });

  function startAnimation() {
    const epsilon = parseFloat(document.getElementById("epsilon").value);
    const minPts = parseInt(document.getElementById("minPts").value);

    if (isNaN(epsilon) || isNaN(minPts)) {
      alert("Please enter valid epsilon and minPts values");
      return;
    }

    fetch("{% url 'generate_video' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({
        points,
        epsilon,
        minPts
      })
    })
    .then(response => response.json())
    .then(data => {
      const frameCount = data.frames;
      let current = 0;
      const interval = setInterval(() => {
        document.getElementById("frameImg").src = `/media/frames/frame_${current}.png?${Date.now()}`;
        current++;
        if (current >= frameCount) clearInterval(interval);
      }, 300);
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
